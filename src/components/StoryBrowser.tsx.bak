'use client';

import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';

interface Story {
  id: string;
  story_index: number;
  media_type: 'image' | 'video';
  cdn_url: string;
  duration?: number;
  location_name?: string;
  latitude?: number;
  longitude?: number;
  estimated_date?: string;
  collection_id: string;
  collection?: {
    name: string;
    region?: string;
    expedition_phase?: string;
  };
}

interface StoryCollection {
  id: string;
  name: string;
  story_count: number;
  region?: string;
  expedition_phase?: string;
}

interface Filters {
  collection: string;
  region: string;
  phase: string;
  mediaType: string;
  search: string;
}

export default function StoryBrowser() {
  const [stories, setStories] = useState<Story[]>([]);
  const [collections, setCollections] = useState<StoryCollection[]>([]);
  const [loading, setLoading] = useState(true);
  const [currentPage, setCurrentPage] = useState(1);
  const [totalStories, setTotalStories] = useState(0);
  const [filters, setFilters] = useState<Filters>({
    collection: '',
    region: '',
    phase: '',
    mediaType: '',
    search: ''
  });

  const STORIES_PER_PAGE = 50;

  // Fetch collections for filtering
  useEffect(() => {
    const fetchCollections = async () => {
      try {
        console.log('Fetching collections...');
        const { data, error } = await supabase
          .from('story_collections')
          .select('id, name, story_count, region, expedition_phase')
          .order('name');

        if (error) {
          console.error('Collections error:', error);
          throw error;
        }
        
        console.log('Collections loaded:', data?.length || 0);
        setCollections(data || []);
      } catch (error) {
        console.error('Error fetching collections:', error);
      }
    };

    fetchCollections();
  }, []);

  // Fetch stories with pagination and filters
  useEffect(() => {
    const fetchStories = async () => {
      setLoading(true);
      try {
        console.log('Fetching stories with filters:', filters);
        
        // First, get stories with collection info using a simpler approach
        let baseQuery = supabase
          .from('stories')
          .select(`
            id,
            story_index,
            media_type,
            cdn_url,
            duration,
            location_name,
            latitude,
            longitude,
            estimated_date,
            collection_id
          `);

        // Apply direct story filters first
        if (filters.collection) {
          baseQuery = baseQuery.eq('collection_id', filters.collection);
        }
        if (filters.mediaType) {
          baseQuery = baseQuery.eq('media_type', filters.mediaType);
        }
        if (filters.search && !filters.region && !filters.phase) {
          // Only search location_name if not filtering by collection-specific fields
          baseQuery = baseQuery.ilike('location_name', `%${filters.search}%`);
        }

        // Get collection data separately for better reliability
        const { data: collectionsData } = await supabase
          .from('story_collections')
          .select('id, name, region, expedition_phase');

        // Create collection lookup map
        const collectionMap = new Map(
          collectionsData?.map(col => [col.id, col]) || []
        );

        // Apply collection-based filters
        if (filters.region || filters.phase || (filters.search && (filters.region || filters.phase))) {
          const filteredCollectionIds = collectionsData
            ?.filter(col => {
              if (filters.region && col.region !== filters.region) return false;
              if (filters.phase && col.expedition_phase !== filters.phase) return false;
              if (filters.search && filters.region) {
                return col.name?.toLowerCase().includes(filters.search.toLowerCase());
              }
              return true;
            })
            .map(col => col.id) || [];

          if (filteredCollectionIds.length > 0) {
            baseQuery = baseQuery.in('collection_id', filteredCollectionIds);
          } else {
            // No matching collections, return empty result
            setStories([]);
            setTotalStories(0);
            setLoading(false);
            return;
          }
        }

        // Get total count
        const { count, error: countError } = await baseQuery
          .select('*', { count: 'exact', head: true });

        if (countError) {
          console.error('Count error:', countError);
          throw countError;
        }

        setTotalStories(count || 0);

        // Get paginated results
        const { data: storiesData, error } = await baseQuery
          .order('collection_id', { ascending: true })
          .order('story_index', { ascending: true })
          .range((currentPage - 1) * STORIES_PER_PAGE, currentPage * STORIES_PER_PAGE - 1);

        if (error) {
          console.error('Stories query error:', error);
          throw error;
        }

        // Add collection info to stories
        const formattedStories = storiesData?.map(story => ({
          ...story,
          collection: collectionMap.get(story.collection_id)
        })) || [];

        setStories(formattedStories);
      } catch (error) {
        console.error('Error fetching stories:', error);
        // Set empty state on error
        setStories([]);
        setTotalStories(0);
      } finally {
        setLoading(false);
      }
    };

    fetchStories();
  }, [currentPage, filters]);

  const updateFilter = (key: keyof Filters, value: string) => {
    setFilters(prev => ({ ...prev, [key]: value }));
    setCurrentPage(1); // Reset to first page when filtering
  };

  const clearFilters = () => {
    setFilters({
      collection: '',
      region: '',
      phase: '',
      mediaType: '',
      search: ''
    });
    setCurrentPage(1);
  };

  const totalPages = Math.ceil(totalStories / STORIES_PER_PAGE);
  const uniqueRegions = [...new Set(collections.map(c => c.region).filter(Boolean))];
  const uniquePhases = [...new Set(collections.map(c => c.expedition_phase).filter(Boolean))];

  return (
    <div className="space-y-6">
      {/* Filters */}
      <div className="bg-white p-6 rounded-lg shadow">
        <h2 className="text-lg font-semibold text-gray-900 mb-4">Filter Stories</h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-4">
          {/* Search */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Search
            </label>
            <input
              type="text"
              value={filters.search}
              onChange={(e) => updateFilter('search', e.target.value)}
              placeholder="Collection or location..."
              className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
            />
          </div>

          {/* Collection */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Collection
            </label>
            <select
              value={filters.collection}
              onChange={(e) => updateFilter('collection', e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
            >
              <option value="">All Collections</option>
              {collections.map(collection => (
                <option key={collection.id} value={collection.id}>
                  {collection.name} ({collection.story_count})
                </option>
              ))}
            </select>
          </div>

          {/* Region */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Region
            </label>
            <select
              value={filters.region}
              onChange={(e) => updateFilter('region', e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
            >
              <option value="">All Regions</option>
              {uniqueRegions.map(region => (
                <option key={region} value={region}>{region}</option>
              ))}
            </select>
          </div>

          {/* Expedition Phase */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Phase
            </label>
            <select
              value={filters.phase}
              onChange={(e) => updateFilter('phase', e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
            >
              <option value="">All Phases</option>
              {uniquePhases.map(phase => (
                <option key={phase} value={phase}>{phase}</option>
              ))}
            </select>
          </div>

          {/* Media Type */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Media Type
            </label>
            <select
              value={filters.mediaType}
              onChange={(e) => updateFilter('mediaType', e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
            >
              <option value="">All Types</option>
              <option value="image">Images</option>
              <option value="video">Videos</option>
            </select>
          </div>

          {/* Clear Filters */}
          <div className="flex items-end">
            <button
              onClick={clearFilters}
              className="w-full px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-sm"
            >
              Clear All
            </button>
          </div>
        </div>

        {/* Results Summary */}
        <div className="text-sm text-gray-600">
          Showing {stories.length} of {totalStories.toLocaleString()} stories
          {totalPages > 1 && ` (Page ${currentPage} of ${totalPages})`}
        </div>
      </div>

      {/* Story Grid */}
      {loading ? (
        <div className="flex justify-center items-center h-64">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        </div>
      ) : (
        <>
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-4">
            {stories.map((story) => (
              <div
                key={story.id}
                className="group relative bg-white rounded-lg shadow hover:shadow-lg transition-shadow duration-200"
              >
                <div className="aspect-square relative overflow-hidden rounded-t-lg">
                  {story.media_type === 'video' ? (
                    <div className="w-full h-full bg-gray-200 flex items-center justify-center">
                      <div className="text-center">
                        <div className="text-2xl mb-1">🎥</div>
                        <div className="text-xs text-gray-500">
                          {story.duration}s
                        </div>
                      </div>
                    </div>
                  ) : (
                    <img
                      src={story.cdn_url}
                      alt={`Story ${story.story_index}`}
                      className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"
                      loading="lazy"
                    />
                  )}
                  
                  {/* Media type indicator */}
                  <div className="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-1 py-0.5 rounded text-xs">
                    {story.media_type === 'video' ? '🎥' : '📷'}
                  </div>
                </div>

                {/* Story Info */}
                <div className="p-3">
                  <div className="text-xs font-medium text-gray-900 truncate mb-1">
                    {story.collection?.name}
                  </div>
                  <div className="text-xs text-gray-500 truncate">
                    #{story.story_index}
                    {story.location_name && ` • ${story.location_name}`}
                  </div>
                  {story.collection?.region && (
                    <div className="text-xs text-indigo-600 truncate mt-1">
                      {story.collection.region}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* Pagination */}
          {totalPages > 1 && (
            <div className="flex justify-center items-center space-x-2 mt-8">
              <button
                onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                disabled={currentPage === 1}
                className="px-4 py-2 border border-gray-300 rounded-md text-sm disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Previous
              </button>
              
              <div className="flex items-center space-x-1">
                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                  let pageNum;
                  if (totalPages <= 5) {
                    pageNum = i + 1;
                  } else if (currentPage <= 3) {
                    pageNum = i + 1;
                  } else if (currentPage >= totalPages - 2) {
                    pageNum = totalPages - 4 + i;
                  } else {
                    pageNum = currentPage - 2 + i;
                  }
                  
                  return (
                    <button
                      key={pageNum}
                      onClick={() => setCurrentPage(pageNum)}
                      className={`px-3 py-2 text-sm rounded-md ${
                        pageNum === currentPage
                          ? 'bg-indigo-600 text-white'
                          : 'border border-gray-300 hover:bg-gray-50'
                      }`}
                    >
                      {pageNum}
                    </button>
                  );
                })}
              </div>

              <button
                onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                disabled={currentPage === totalPages}
                className="px-4 py-2 border border-gray-300 rounded-md text-sm disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Next
              </button>
            </div>
          )}
        </>
      )}
    </div>
  );
}